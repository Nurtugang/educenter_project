{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block head %}
    <link rel="stylesheet" href="{% static 'quizer/css/quizer_results_style.css' %}">
    <!-- Chart.js –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
    .stat-card {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
        color: #ed7e4a;
        font-size: 28px;
        margin-bottom: 5px;
    }

    .stat-card p {
        color: #8a8a8a;
        font-size: 14px;
        margin: 0;
    }

    .chart-container {
        background-color: white;
        padding: 30px;
        border-radius: 5px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .table-excellent {
        background-color: #d4edda !important;
    }
    
    .table-good {
        background-color: #d1ecf1 !important;
    }
    
    .table-average {
        background-color: #fff3cd !important;
    }
    
    .table-poor {
        background-color: #f8d7da !important;
    }
    
    .change-indicator {
        font-weight: bold;
    }
    
    .change-up {
        color: #28a745;
    }
    
    .change-down {
        color: #dc3545;
    }
    
    .change-same {
        color: #6c757d;
    }
    </style>
{% endblock head %}

{% block content %}

<section id="page-banner" class="pt-55 pb-60 bg_cover" data-overlay="8">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="page-banner-cont">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'index' %}">–î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'quizer_choose' %}">–í—ã–±–æ—Ä —Ç–µ—Å—Ç–∞</a></li>
                            <li class="breadcrumb-item active" aria-current="page">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="pt-30 pb-120 gray-bg">
    <div class="container">
        <div class="results-label">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</div>
        <p>–ü—Ä–µ–¥–º–µ—Ç: {{quiz}}. –Ø–∑—ã–∫: {{language}}</p>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        {% if stats.total_attempts > 0 %}
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <h3>{{stats.total_attempts}}</h3>
                    <p>–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <h3>{{stats.average_score}}%</h3>
                    <p>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <h3>{{stats.best_score}}%</h3>
                    <p>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <h3>{{stats.last_score}}%</h3>
                    <p>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        {% if stats.total_attempts > 1 %}
        <div class="row mb-4">
            <!-- –î–∏–Ω–∞–º–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <h4><strong>–î–∏–Ω–∞–º–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</strong></h4>
                    <div class="chart-wrapper">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <h4><strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫</strong></h4>
                    <div class="chart-wrapper">
                        <canvas id="attemptsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="table-container" style="overflow-x: auto;">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="text-center">–ü–æ–ø—ã—Ç–∫–∞</th>
                        <th class="text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                        <th class="text-center">–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                        <th class="text-center">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                        <th class="text-center">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</th>
                        <th class="text-center">–û—Ç—á–µ—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr class="
                        {% if result.percentage >= 80 %}table-excellent
                        {% elif result.percentage >= 60 %}table-good  
                        {% elif result.percentage >= 40 %}table-average
                        {% else %}table-poor{% endif %}">
                        <td class="text-center">{{ result.attempt_number }}</td>
                        <td class="text-center">{{ result.correct_answers_count }}/{{ result.total_questions_count }}</td>
                        <td class="text-center"><strong>{{ result.percentage }}%</strong></td>
                        <td class="text-center">
                            {% if result.change_direction == 'first' %}
                                <span class="text-muted">–ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞</span>
                            {% elif result.change_direction == 'up' %}
                                <span class="change-indicator change-up">‚Üë +{{ result.change }}%</span>
                            {% elif result.change_direction == 'down' %}
                                <span class="change-indicator change-down">‚Üì {{ result.change }}%</span>
                            {% elif result.change_direction == 'same' %}
                                <span class="change-indicator change-same">‚Üí {{ result.change }}%</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-primary mr-2 btn-question view-result-btn" data-toggle="modal" data-target="#resModal_{{ result.attempt_number }}">
                                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                            </button>
                        </td>
                        <td class="text-center">
                            <form action="{% url 'generate-document' quiz_id result.attempt_number %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary mr-2 btn-question">
                                    <i class="fa fa-file-word-o" aria-hidden="true"></i> –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                                </button>
                            </form>
                        </td>
                    </tr>
                    
                    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏ -->
                    <div class="modal fade" id="resModal_{{ result.attempt_number }}" tabindex="-1" role="dialog" aria-labelledby="resModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title" id="resModalLabel">–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏ - –ü–æ–ø—ã—Ç–∫–∞ ‚Ññ{{ result.attempt_number }}</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    {% if result.correct_answers_count != result.total_questions_count %}
                                        {% for user_answer, correct_answer in result.data %}
                                            <div class="question-container">
                                                <div class="question">
                                                    <h5>
                                                        {{ forloop.counter }}. {{ user_answer.question }}
                                                    </h5>
                                                </div>
                                                <div class="question-image mt-3 mb-3">
                                                    {% if user_answer.question.image %}
                                                        <img src="{{ user_answer.question.image.url }}" class="img-fluid">
                                                    {% endif %}
                                                </div>
                                                <div class="answers">
                                                    <p>–í–∞—à –æ—Ç–≤–µ—Ç: <span style="color: red">{{ user_answer.answer.text }}</span></p>
                                                    <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: <span style="color: green">{{ correct_answer.text }}</span></p>
                                                </div>
                                                <br>                                                    
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <h4>–í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ! üéâ</h4>
                                        <p>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –æ—Ç–ª–∏—á–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="navigation-buttons">
            <a href="{% url 'quizer_choose' %}" id="next" type="button" class="btn btn-primary">–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä–∞–º —Ç–µ—Å—Ç–æ–≤</a>
        </div>
    </div>
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>

<script>
// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Django
const chartData = {{chart_data|safe}};

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤
const colors = {
    primary: '#47a5c9',
    secondary: '#ed7e4a',
    success: '#28a745',
    warning: '#ffc107',
    danger: '#dc3545'
};

// –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏)
{% if stats.total_attempts > 1 %}
const progressCtx = document.getElementById('progressChart').getContext('2d');
new Chart(progressCtx, {
    type: 'line',
    data: {
        labels: chartData.attempts.map(attempt => '–ü–æ–ø—ã—Ç–∫–∞ ' + attempt),
        datasets: [{
            label: '–†–µ–∑—É–ª—å—Ç–∞—Ç (%)',
            data: chartData.scores,
            borderColor: colors.primary,
            backgroundColor: colors.primary + '20',
            borderWidth: 3,
            fill: true,
            tension: 0.1,
            pointBackgroundColor: colors.primary,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    stepSize: 10,
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const dataPoint = chartData.detailed_data[context.dataIndex];
                        return `${context.parsed.y.toFixed(1)}% (${dataPoint.correct}/${dataPoint.total})`;
                    }
                }
            }
        }
    }
});

// –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫
const attemptsCtx = document.getElementById('attemptsChart').getContext('2d');
new Chart(attemptsCtx, {
    type: 'bar',
    data: {
        labels: chartData.attempts.map(attempt => '–ü–æ–ø—ã—Ç–∫–∞ ' + attempt),
        datasets: [{
            label: '–†–µ–∑—É–ª—å—Ç–∞—Ç (%)',
            data: chartData.scores,
            backgroundColor: chartData.scores.map(score => {
                if (score >= 80) return colors.success;
                if (score >= 60) return colors.primary;
                if (score >= 40) return colors.warning;
                return colors.danger;
            }),
            borderColor: chartData.scores.map(score => {
                if (score >= 80) return colors.success;
                if (score >= 60) return colors.primary;
                if (score >= 40) return colors.warning;
                return colors.danger;
            }),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    stepSize: 10,
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const dataPoint = chartData.detailed_data[context.dataIndex];
                        return `${context.parsed.y.toFixed(1)}% (${dataPoint.correct}/${dataPoint.total})`;
                    }
                }
            }
        }
    }
});
{% endif %}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
$(document).ready(function() {
    $('.view-result-btn').click(function() {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞
    });
});
</script>

<script>
	{% if user.is_authenticated %}
			{% if user.groups.all.first.name == '–°—Ç—É–¥–µ–Ω—Ç' %}	
				document.querySelectorAll('#navbarSupportedContent ul li')[5].querySelector('a').classList.add('active');
			{% else %}
				document.querySelectorAll('#navbarSupportedContent ul li')[7].querySelector('a').classList.add('active');
			{% endif %}
	{% else %}
		document.querySelectorAll('#navbarSupportedContent ul li')[4].querySelector('a').classList.add('active');
	{% endif %}
</script>

{% endblock content %}